#!/usr/bin/env bash

if [[ $1 == '-t' ]]; then
  is_title=1
  shift
fi

tmux_loc="$1"
tmux_dir="$2"
local_info="$3"
cmd="$4"
tmux_flags="$5"

shopt -s extglob

tmux_flags="${tmux_flags//\*}"      # *: current window  flag removed
tmux_flags="${tmux_flags//-/}"      # -: last window     flag removed
tmux_flags="${tmux_flags//+(#)/⦁}"  # #: window activity flag replaced by (⦁)
tmux_flags="${tmux_flags//+(~)/}"  # ~: window silenced flag replaced by ()
tmux_flags="${tmux_flags//+(!)/}"   # !: window bell     flag removed
tmux_flags="${tmux_flags//+(Z)/}"  # Z: window zoomed   flag replaced by ()

local_loc="${local_info%:*}"
local_info="${local_info#*:}"
local_info="${local_info#\~/}"
local_info="${local_info#src/}"
local_info="${local_info#$tmux_dir}"
local_info="${local_info#/}"

if [[ $local_loc != $local_info && $tmux_loc != $local_loc ]]; then
  myloc="$local_loc:"
fi

case "$cmd" in
  irssi)
    if [[ $is_title ]]; then
      echo "$cmd"
    else
      echo -n "󰭹 IRC"
    fi
    ;;
  bash|zsh|sh|fish|tcsh|csh)
    myloc="$myloc$local_info"
    if [[ $is_title ]]; then
      echo "${myloc:-.}"
    else
      if [[ $tmux_dir == ~ ]]; then
        echo -n "󰋜${myloc:+ $myloc}"
      else
        echo -n "󰝰${myloc:+ $myloc}"
      fi
    fi
    ;;
  vi|vim|nvim)
    if [[ $is_title ]]; then
      echo "$local_info"
    else
      echo -n "${local_info:+ $local_info}"
    fi
    ;;
  cabal)
    if [[ $is_title ]]; then
      echo "$cmd${local_info:+ $local_info}"
    else
      echo -n "${local_info:+ $local_info}"
    fi
    ;;
  ghci)
    if [[ $is_title ]]; then
      echo "$cmd${local_info:+ $local_info}"
    else
      echo -n "${local_info:+ $local_info}"
    fi
    ;;
  make)
    if [[ $is_title ]]; then
      echo "Building${local_info:+ $local_info}..."
    else
      echo -n "${local_info:+ $local_info} 󱑞"
    fi
    ;;
  *)
    echo -n "$cmd"
    ;;
esac

[[ $is_title ]] || echo " $tmux_flags"
