#!/usr/bin/env bash

# Git Status for Vim

case "$OSTYPE" in
  darwin*)
    statm() { stat -f %m -- "$@"; }
    ;;
  linux*)
    statm() { stat --printf %Y -- "$@"; }
    ;;
  *)
    statm() { return 0; }
esac

if [[ $1 ]]; then
  cd -- "$(dirname -- "$1")"
fi

unset git_branch git_ahead git_behind git_extrastatus

git_status=

if ! type -p git > /dev/null; then
  exit
fi

while true; do
  case "$(git rev-parse --is-inside-git-dir 2> /dev/null)" in
    true)  cd ..;;
    false) break;;
    *)     exit;;
  esac
done

# if we're in a repo with a readable .git dir (but not in $HOME) # && $HOME != "$(git rev-parse --show-toplevel)"
if [[ -e $(git rev-parse --git-dir 2>/dev/null) ]]; then
  if [[ $1 ]] && git check-ignore -q -- "$1"; then
    exit 0
  fi
  # get the repo dir
  repo="$(git rev-parse --show-toplevel)"
  # do a fetch if we haven't done one for more than a minute
  if [[ ! ( -r $repo/.git/FETCH_HEAD ) || ( $(( $(date +%s) - $(statm "$repo"/.git/FETCH_HEAD) )) -gt 60 ) ]]; then
    (
      git fetch --quiet &> /dev/null & disown -a
    )
  fi
  status="$(git status --porcelain=1 -b)"
  status1="$(head -1 <<< "$status")"
  git_branch="$(cut -c4- <<< "$status1")"
  git_branch="${bashrc_git_branch%%\.\.\.*}"
  if [[ $git_branch =~ master|main ]]; then
    git_branch=
  fi
  git_ahead="$(/usr/bin/grep ahead <<< "$status1" | sed 's/.*ahead \([0-9]*\).*/\1/')"
  git_behind="$(/usr/bin/grep behind <<< "$status1" | sed 's/.*behind \([0-9]*\).*/\1/')"
  if git stash list | /usr/bin/grep . > /dev/null 2>&1; then
    bashrc_git_hasstash='#'
  else
    bashrc_git_hasstash=
  fi
  git_extrastatus="$(/usr/bin/grep -q '^[ACDMRT]' <<< "$status" && printf S; /usr/bin/grep -q '^.[CDMRT]' <<< "$status" && printf M)$bashrc_git_hasstash" #; /usr/bin/grep -q ^\?\? <<< "$status" && printf U)"
  git_status="$git_branch${git_ahead:+↑$git_ahead}${git_behind:+↓$git_behind}$git_extrastatus"
fi

printf %s "${git_status:+%#GitBG#${git_branch:+%#GitBranch#$git_branch}${git_ahead:+%#GitAhead#↑$git_ahead}${git_behind:+%#GitBehind#↓$git_behind}${git_extrastatus:+%#GitFlags#$git_extrastatus}%*%#GitBG#%#StatusLine# }"
